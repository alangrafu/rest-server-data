<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>(GOV) Recline Data Explorer</title>
<meta name="description" content="The (GOV) Recline Data Explorer">
<meta name="author" content="Alvaro Graves">
<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<link rel="stylesheet" href="recline/vendor/bootstrap/2.0.2/css/bootstrap.css" />


<link rel="stylesheet" href="recline/vendor/leaflet/0.3.1/leaflet.css">
<!--[if lte IE 8]>
<link rel="stylesheet" href="recline/vendor/leaflet/0.3.1/leaflet.ie.css" />
<![endif]-->
<link rel="stylesheet" href="recline/vendor/slickgrid/2.0.1/slick.grid.css">

<!-- Recline CSS components -->
<link rel="stylesheet" href="recline/css/grid.css">
<link rel="stylesheet" href="recline/css/graph.css">
<link rel="stylesheet" href="recline/css/map.css">
<link rel="stylesheet" href="recline/css/gov-explorer.css">
<link rel="stylesheet" href="recline/css/multiview.css">
<!-- /Recline CSS components -->

<!-- 3rd party JS libraries -->

<!--
The recline library itself - this includes all components at once.

You can include just the components you need e.g.

<script type="text/javascript" src="recline/src/model.js"></script>
<script type="text/javascript" src="recline/src/backend/base.js"></script>
<script type="text/javascript" src="recline/src/backend/memory.js"></script>
-->
<link rel="stylesheet" href="recline/vendor/bootstrap/2.0.2/css/bootstrap-responsive.css">
<link href="recline/css/site/pygments.css" rel="stylesheet" type="text/css" />
<link href="recline/css/site/site.css" rel="stylesheet" type="text/css" />


  <script type="text/javascript" src="recline/vendor/jquery/1.7.1/jquery.js"></script>
  <script type="text/javascript" src="recline/vendor/underscore/1.1.6/underscore.js"></script>
  <script type="text/javascript" src="recline/vendor/backbone/0.5.1/backbone.js"></script>
  <script type="text/javascript" src="recline/vendor/moment/1.6.2/moment.js"></script>
  <script type="text/javascript" src="recline/vendor/jquery.flot/0.7/jquery.flot.js"></script>
  <script type="text/javascript" src="recline/vendor/mustache/0.5.0-dev/mustache.js"></script>
  <script type="text/javascript" src="recline/vendor/bootstrap/2.0.2/bootstrap.js"></script>
  <script type="text/javascript" src="recline/vendor/leaflet/0.3.1/leaflet.js"></script>
  <script type="text/javascript" src="recline/vendor/slickgrid/2.0.1/jquery-ui-1.8.16.custom.min.js"></script>
  <script type="text/javascript" src="recline/vendor/slickgrid/2.0.1/jquery.event.drag-2.0.min.js"></script>
  <script type="text/javascript" src="recline/vendor/slickgrid/2.0.1/slick.grid.min.js"></script>
  <script type="text/javascript" src="recline/vendor/timeline/20120520/js/timeline.js"></script>

  <!-- recline library -->
  <!-- in normal use would just the single recline.js library file. However, for testing it
  is easier to reference individual files. See built.html for example using just recline.js -->
  <script type="text/javascript" src="recline/src/costco.js"></script>
  <script type="text/javascript" src="recline/src/model.js"></script>
  <script type="text/javascript" src="recline/src/backend/base.js"></script>
  <script type="text/javascript" src="recline/src/backend/memory.js"></script>
  <script type="text/javascript" src="recline/src/backend/dataproxy.js"></script>
  <script type="text/javascript" src="recline/src/backend/elasticsearch.js"></script>
  <script type="text/javascript" src="recline/src/backend/gdocs.js"></script>
  <script type="text/javascript" src="recline/src/backend/csv.js"></script>

  <script type="text/javascript" src="recline/src/view.grid.js"></script>
  <script type="text/javascript" src="recline/src/view.slickgrid.js"></script>
  <script type="text/javascript" src="recline/src/view.transform.js"></script>
  <script type="text/javascript" src="recline/src/view.graph.js"></script>
  <script type="text/javascript" src="recline/src/view.map.js"></script>
  <script type="text/javascript" src="recline/src/view.timeline.js"></script>
  <script type="text/javascript" src="recline/src/widget.pager.js"></script>
  <script type="text/javascript" src="recline/src/widget.queryeditor.js"></script>
  <script type="text/javascript" src="recline/src/widget.filtereditor.js"></script>
  <script type="text/javascript" src="recline/src/widget.fields.js"></script>
  <script type="text/javascript" src="recline/src/view.multiview.js"></script>
  <script type="text/javascript" src="recline/src/md5.js"></script>
  <script type="text/javascript" src="recline/rdfquery/jquery.rdfquery.core.min-1.0.js"></script>
  <script type="text/javascript" src="recline/rdfquery/jquery.rdf.js"></script>
  <script type="text/javascript" src="recline/rdfquery/jquery.rdf.xml.js"></script>
  <script type="text/javascript" src="recline/rdfquery/jquery.rdf.json.js"></script>
  <script type="text/javascript" src="recline/rdfquery/jquery.rdf.turtle.js"></script>
</head>
<body>
<button id="add-dataset" class="btn btn-primary">+</button>

<script type="text/javascript">
(function ($) {
    var provenances = {};
    
    var DatasetCollection = Backbone.Collection.extend({
        model: recline.Model.Dataset,
        events: 'add'
    });
    var datasetCollection =  new DatasetCollection();
    
    var dataproxy_url = 'http://alia:8000';
    var counter=0;
    
    window.AppView = Backbone.View.extend({
        el: $("body"),
        initialize: function(){
          datasetCollection.bind('add', this.add, this);
        },
        events: {
          "click #add-dataset":  "addDataset",
          "click #import-dataset": "importDataset",
          "click .remove-dataset": "removeDataset",
          "click .create-graph-dialog": "createGraphDialog",
          "click #create-graph": "createGraph",
          "click .create-map-dialog": "createMapDialog",
          "click #create-map": "createMap",
          "click .export-dialog": "exportDialog",
        },
        _addProvenance: function(obj){
          id = obj.id;
          visType = obj.visType;
          source = obj.source;
          console.log(obj);
          creationDate = new Date();
          visClass = visType.charAt(0).toUpperCase() + visType.slice(1).toLowerCase();
          provenance = $.rdf.databank().base("http://alia/gov/viz/"+creationDate.getTime().toString()).prefix('foaf', 'http://xmlns.com/foaf/0.1/')
          .prefix('dc', 'http://purl.org/dc/terms/')
          .prefix('viz', 'http://graves.cl/vizon/')
          .prefix('rdfs', 'http://www.w3.org/2000/01/rdf-schema#')
          .prefix('void', 'http://rdfs.org/ns/void#');
          provenance.add('<> dc:source <'+source+'> .')
          .add('<> a viz:'+visClass+'Visualization .')
          .add('<> dc:created "'+creationDate.toISOString()+'" .');
          
          //Graph parameters
          if(obj.group != undefined){
            gId = '_:group1';
            provenance.add('<> viz:hasParameter '+gId).add(gId+' a viz:Parameter ').add(gId+' viz:parameterValue "'+obj.group+'"').add(gId+' rdfs:label "group" ');
          }          
          if(obj.series != undefined){
            for(seriesCounter = 0; seriesCounter< obj.series.length; seriesCounter++){
              sId = '_:series'+seriesCounter;
              provenance.add('<> viz:hasParameter '+sId).add(sId+' a viz:Parameter').add(sId+' viz:parameterValue "'+obj.series[seriesCounter]+'" ').add(sId+' rdfs:label "series" ');
            }
          }
          
          //Map parameters
          if(obj.lat != undefined){
            gId = '_:lat1';
            provenance.add('<> viz:hasParameter '+gId).add(gId+' a viz:Parameter ').add(gId+' viz:parameterValue "'+obj.lat+'"').add(gId+' rdfs:label "lat" ');
          }
          if(obj.lon != undefined){
            gId = '_:lon1';
            provenance.add('<> viz:hasParameter '+gId).add(gId+' a viz:Parameter ').add(gId+' viz:parameterValue "'+obj.lon+'"').add(gId+' rdfs:label "lon" ');
          }          
          provenances[id+"-"+visType] = provenance;
          provenances[id+"-"+visType+"-id"] = "http://alia/gov/viz/"+creationDate.getTime().toString();
        },
        exportDialog: function(e){
          var provId=$(e.target).attr("id");
          console.log(provId);
          provenance = provenances[provId];
          console.log(provenance);
          uri = provenances[provId+"-id"];
          console.log(provenance.dump({format: 'text/turtle', serialize: true}));
          encodedgraph = provenance.dump({format: 'text/turtle', serialize: true});
          url = 'http://alia:4567/registerViz';
          $.ajax({
                url: url,
                dataType: 'jsonp',
                data:{
                  encodedgraph: encodedgraph,
                  uri: uri
                },
                jsonpCallback: 'callback',
                success: function(d){
                  $("#export-textarea").html(d.uri);
                  $("#export-msg").modal('show');
                }
          });
        },
        createMapDialog: function(e){
          $(".map-long-combo").empty();
          $(".map-long-combo").empty();
          var containerId=$(e.target).parent().parent().attr("id");
          $("#map-id").val("#"+containerId+">.map");
          var el = $("#"+containerId+" .Map");
          var fields = (datasetCollection.models[0]).fields.models;
          for( i in fields){
            $(".map-long-combo").append("<option value='"+fields[i].id+"'>"+fields[i].id+"</option>");
            $(".map-lat-combo").append("<option value='"+fields[i].id+"'>"+fields[i].id+"</option>");
          }
          $("#map-msg").modal('show');
        },
        createMap: function(e){
          $("#map-msg").modal('hide');
          mapDiv = $("#map-id").val();
          var el = $(mapDiv);
          el.empty();
          var lat = $(".map-lat-combo option:selected").val();
          var lon = $(".map-long-combo option:selected").val();
          var map = new recline.View.Map({
              model: datasetCollection.models[0],
              state: {
                lonField: lon,
                latField: lat,
              }
          });
          this._addProvenance({ id: $(mapDiv).attr("id"), visType: 'map', source: source, lat: lat, lon: lon});
          el.append(map.el);
          visId = 'map'+counter;
          el.prepend('<div style="display:inline-block;"><button id="'+visId+'-map" type="button" class="btn-warning btn btn-small menu-button export-dialog"><i class="icon-share"></i> Share this visualization</button><span class="provenance"></span></div>');          
          map.redraw();
        },
        createGraphDialog: function(e){
          $(".y-axis-combo").empty();
          $(".x-axis-combo").empty();
          var containerId=$(e.target).parent().parent().attr("id");
          $("#graph-id").val("#"+containerId+">.graph");
          var el = $("#"+containerId+" .graph");
          var fields = (datasetCollection.models[0]).fields.models;
          for( i in fields){
            $(".y-axis-combo").append("<option value='"+fields[i].id+"'>"+fields[i].id+"</option>");
            $(".x-axis-combo").append("<option value='"+fields[i].id+"'>"+fields[i].id+"</option>");
          }
          $("#graph-msg").modal('show');
        },
        createGraph: function(e){
          $("#graph-msg").modal('hide');
          graphDiv = $("#graph-id").val();
          var el = $(graphDiv);
          el.empty();
          var series = [];
          var group = $(".x-axis-combo option:selected").val();
          $(".y-axis-combo option:selected").each(function(i, item){
              series.push($(item).val());
          });
          var graph = new recline.View.Graph({
              model: datasetCollection.models[0],
              state: {
                graphType: "lines-and-points",
                group: group,
                series: series
              }
          });
          this._addProvenance({ id: $(graphDiv).attr("id"), visType: 'graph', source: source, series: series, group: group});
          el.append(graph.el);
          visId = 'graph'+counter;
          el.prepend('<div style="display:inline-block;"><button id="'+visId+'-graph" type="button" class="btn-warning btn btn-small menu-button export-dialog"><i class="icon-share"></i> Share this visualization</button><span class="provenance"></span></div>');          
          graph.redraw();
        },
        add: function(){
          if(datasetCollection.length>1){
            console.log("mas de 2 datasets in colection");
            $("#add-dataset").attr("disabled", "disable");
          }
        },
        removeDataset: function(){
          console.log("remove");
        },
        addDataset: function () {
          $("#import-url-dialog").modal('show');
        },
        importDataset: function(){
          $("#import-url-dialog").modal('hide'); 
          $("#wait-msg").modal('show');
          $("#progress-bar").css("width", "20%");          
          var source = $("#dataset-url").val();
          counter++;
          console.log("source: "+source);
          url = 'http://alia:4567/dataset/'+source.replace(/^http:\/\//gi, '');
            var currentObj = this;
            $.ajax({
                url: url,
                dataType: 'jsonp',
                jsonpCallback: 'callback',
                success: function(d){
                  $("#progress-bar").css("width", "50%");          
                  console.log("Local identifier: "+d.data);
                  source = d.data;
                  if(source == "nil" || source == ""){
                    $("#wait-msg").modal('hide');
                    $("#error-msg").modal('show');
                  }else{
                    var datasetInfo = {
                      id: 'my-dataset'+(counter),
                      url: source,
                      format: 'csv',
                      webstore_url: source,
                    };
                    type = 'dataproxy';
                    var dataset = null;
                    dataset = new recline.Model.Dataset(datasetInfo, type);
                    dataset.backend.dataproxy_url = dataproxy_url;
                    containerId = "mycontainer"+(counter);
                    visId = "grid"+(counter);
                    newDiv = $('<div class="viz-container" id="'+containerId+'"><div class="grid recline-read-only" id="'+(visId)+'"><div style="display:inline-block;"><button id="'+visId+'-grid" type="button" class="btn-warning btn btn-small menu-button export-dialog"><i class="icon-share"></i> Share this visualization</button></div></div></div>');
                    newDiv.appendTo('#content');
                    currentObj._addProvenance({ id: visId, visType: 'grid', source: source});
                    $("<div class='graph' id='graph"+(counter)+"'></div>").appendTo(newDiv);
                    $("<div class='map' id='map"+(counter)+"'></div>").appendTo(newDiv);

                    var $el = $('#'+visId);
                    var grid = new recline.View.Grid({
                        model: dataset,
                        state: {
                          provenance: provenance
                        }
                    });
                    $el.append(grid.el);
                    grid.render();
                    datasetCollection.add(dataset);
                    dataset.fetch().done(function() {
                        dataset.query().done(function(data) {
                            // The grid will update automatically
                            // Log some data as an example
                        });
                    });
                    $("#progress-bar").css("width", "90%");
                    newDiv.prepend('<div data-id="${id}" class="button-container"><button data-id="${id}" type="button" class="btn menu-button btn-small btn-danger remove-dataset" >×</button><button data-id="${id}" type="button" class="btn-small btn-info btn menu-button create-graph-dialog"><i class="icon-picture"></i> Graph</button><button type="button" class="btn-info btn btn-small menu-button create-map-dialog"><i class="icon-map-marker"></i> Map</button></div>')
                    $("#wait-msg").modal('hide');
                  }
                },
                error: function(request,error){
                  $("#wait-msg").modal('hide');
                  $("#error-msg").modal('show');
                }
            });
        },
    });
    var appview = new AppView;
    var code = window.location.hash.substr(1);    
    if(code != ""){
      var newuri = 'http://alia/gov/viz/'+code;
      $.ajax({
          url: newuri,
          dataType: 'json',
          success: function(d){
            $("#dataset-url").val(d.source);
            console.log($("#dataset-url").val());
            appview.importDataset();
          }
      });
    }

})(jQuery);
// ensure modal is only shown on page load
</script>
<div id="content"></div>




<div class="modal hide fade" id="import-url-dialog">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>Dataset URL</h3>
  </div>
  <div class="modal-body">
    <p>Indicate where is the dataset located</p>
    <p><input type="text" id="dataset-url" class="dataset-url-input" value="http://graves.cl/b.csv"/></p>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Close</a>
    <a href="#" class="btn btn-primary" id="import-dataset">OK</a>
  </div>
</div>

<div class="modal hide fade" id="error-msg">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>Error</h3>
  </div>
  <div class="modal-body">
    <p>Dataset couldn't be fetched. Please try later</p>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Ok</a>
  </div>
</div>

<div class="modal hide" id="wait-msg">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>Loading</h3>
  </div>
  <div class="modal-body">
    <div class="progress progress-striped active">
      <div class="bar" style="width: 10%;" id="progress-bar"></div>
    </div>
  </div>
</div>

<div class="modal hide fade" id="graph-msg">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>Select fields</h3>
  </div>
  <div class="modal-body">
    <p><label for="x-axis">X axis</label><select class="x-axis-combo"></select></p>
    <p><label for="y-axis">Y axis</label><select class="y-axis-combo"></select></p>
    <input type="hidden" id="graph-id" value=""/> 
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Close</a>
    <a href="#" class="btn btn-primary" id="create-graph">OK</a>
  </div>
</div>

<div class="modal hide fade" id="map-msg">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>Select fields</h3>
  </div>
  <div class="modal-body">
    <p><label for="map-lat-combo">Latitude</label><select class="map-lat-combo"></select></p>
    <p><label for="map-long-combo">Longitude</label><select class="map-long-combo"></select></p>
    <input type="hidden" id="map-id" value=""/> 
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Close</a>
    <a href="#" class="btn btn-primary" id="create-map">OK</a>
  </div>
</div>

<div class="modal hide fade" id="export-msg">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>Share this link</h3>
  </div>
  <div class="modal-body">
    <p><span id="export-textarea" class="url-msg"></span></p> 
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Close</a>
  </div>
</div>

</body>
</html>

